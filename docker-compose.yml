version: '3.9'

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "SaPass123!"
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "SaPass123!", "-Q", "SELECT 1"]
      interval: 10s
      retries: 30
    networks:
      - parking_net

  auth_service:
    build: ./auth_service
    container_name: auth_service
    ports:
      - "5001:5001"
    networks:
      - parking_net

  vehicle_service:
    build: ./vehicle_service
    container_name: vehicle_service
    ports:
      - "5002:5002"
    environment:
      DB_SERVER: sqlserver
      DB_NAME: VehicleDB
      DB_USER: sa
      DB_PASSWORD: SaPass123!
      AUTH_VERIFY_URL: "http://auth_service:5001/auth/verify"
    depends_on:
      auth_service:
        condition: service_started
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  parking_service:
    build: ./parking_service
    container_name: parking_service
    ports:
      - "5003:5003"
    environment:
      DB_SERVER: sqlserver
      DB_NAME: ParkingDB2
      DB_USER: sa
      DB_PASSWORD: SaPass123!
      AUTH_VERIFY_URL: "http://auth_service:5001/auth/verify"
      VEHICLE_URL: "http://vehicle_service:5002"
    depends_on:
      auth_service:
        condition: service_started
      vehicle_service:
        condition: service_started
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  payment_service:
    build: ./payment_service
    container_name: payment_service
    ports:
      - "5004:5004"
    environment:
      DB_SERVER: sqlserver
      DB_NAME: PaymentDB
      DB_USER: sa
      DB_PASSWORD: SaPass123!
      AUTH_VERIFY_URL: "http://auth_service:5001/auth/verify"
    depends_on:
      auth_service:
        condition: service_started
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  offline_payment_service:
    build: ./offline_payment_service
    container_name: offline_payment_service
    ports:
      - "5008:5008"
    environment:
      DB_SERVER: sqlserver
    depends_on:
      payment_service:
        condition: service_started
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  analytics_service:
    build: ./analytics_service
    container_name: analytics_service
    ports:
      - "5005:5005"
    environment:
      DB_SERVER: sqlserver
    depends_on:
      payment_service:
        condition: service_started
      parking_service:
        condition: service_started
      vehicle_service:
        condition: service_started
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  dashboard_service:
    build: ./dashboard_service
    container_name: dashboard_service
    ports:
      - "8080:8080"
    environment:
      DASHBOARD_SECRET_KEY: "dashboardsecret"
      AUTH_URL_BASE: "http://auth_service:5001"
      PARKING_URL_BASE: "http://parking_service:5003"
      PAYMENT_URL_BASE: "http://payment_service:5004"
      VEHICLE_URL_BASE: "http://vehicle_service:5002"
      OFFLINE_URL_BASE: "http://offline_payment_service:5008"
      OCR_LOCAL_URL: "http://ocr_local:5010/recognize"
    depends_on:
      auth_service:
        condition: service_started
      parking_service:
        condition: service_started
      payment_service:
        condition: service_started
      vehicle_service:
        condition: service_started
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  monitoring_service:
    build: ./monitoring_service
    container_name: monitoring_service
    ports:
      - "5006:5006"
    depends_on:
      auth_service:
        condition: service_started
      vehicle_service:
        condition: service_started
      parking_service:
        condition: service_started
      payment_service:
        condition: service_started
      analytics_service:
        condition: service_started
      dashboard_service:
        condition: service_started
      offline_payment_service:
        condition: service_started
    networks:
      - parking_net

  ocr_service:
    build: ./ocr_service
    container_name: ocr_service
    ports:
      - "5009:5009"
    networks:
      - parking_net

  ocr_local:
    build: ./ocr_local
    container_name: ocr_local
    ports:
      - "5010:5010"
    networks:
      - parking_net

  tariff_service:
    build: ./tariff_service
    container_name: tariff_service
    ports:
      - "5011:5011"
    environment:
      DB_SERVER: sqlserver
      DB_NAME: TariffDB
      DB_USER: sa
      DB_PASSWORD: SaPass123!
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

  notification_service:
    build: ./notification_service
    container_name: notification_service
    ports:
      - "5012:5012"
    environment:
      DB_SERVER: sqlserver
    depends_on:
      sqlserver:
        condition: service_healthy
    restart: on-failure
    networks:
      - parking_net

networks:
  parking_net:
    driver: bridge
